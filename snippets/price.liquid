{%- doc -%}
  This snippet is used to render a product card.
  It is used in the product block,featured product block, and the product card block.

  @param {product} product_resource - The product to render
  @param {boolean} [show_unit_price] - Whether to show the unit price
  @param {boolean} [show_sale_price_first] - Whether to show the sale price first
{%- enddoc -%}

{%- liquid
  assign show_unit_price = show_unit_price | default: false
  assign show_sale_price_first = show_sale_price_first | default: false
  assign selected_variant = product_resource.selected_or_first_available_variant
  assign price = selected_variant.price
  assign compare_at_price = selected_variant.compare_at_price

  assign show_compare_price = false
  if compare_at_price > price
    assign show_compare_price = true
  endif

  if product_resource == blank
    assign price = 1999
  endif

  # Checks if product handle matches the closest product's handle (i.e. product page)
  # and if the currency code is enabled for product pages
  if product.handle == closest.product.handle and settings.currency_code_enabled_product_pages
    assign price = price | money_with_currency
    assign compare_at_price = compare_at_price | money_with_currency

    # Checks if product handle does not match the closest product's handle (i.e. product card)
    # and if the currency code is enabled for product cards
  elsif product.handle != closest.product.handle and settings.currency_code_enabled_product_cards
    assign price = price | money_with_currency
    assign compare_at_price = compare_at_price | money_with_currency

  else
    assign price = price | money
    assign compare_at_price = compare_at_price | money
  endif
-%}

<div ref="priceContainer" style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
  <div>
    {% if show_sale_price_first == false and show_compare_price %}
      <span role="group">
        <span class="visually-hidden">{{ 'content.price_regular' | t }}&nbsp;</span>
        <span class="compare-at-price">{{- compare_at_price -}}</span>
      </span>
    {% endif %}

    {% if show_compare_price %}
      <span role="group">
        <span class="visually-hidden">{{ 'content.price_sale' | t }}&nbsp;</span>
        <span class="price">{{ price | default: '&nbsp;' }}</span>
      </span>
    {% else %}
      <span class="price">{{ price | default: '&nbsp;' }}</span>
    {% endif %}

    {% if show_sale_price_first == true and show_compare_price %}
      <span role="group">
        <span class="visually-hidden">{{ 'content.price_regular' | t }}&nbsp;</span>
        <span class="compare-at-price">{{- compare_at_price -}}</span>
      </span>
    {% endif %}
    {%- if selected_variant.unit_price and show_unit_price %}
      {%- liquid
        if product.handle == closest.product.handle and settings.currency_code_enabled_product_pages
          assign unit_price = selected_variant.unit_price | money_with_currency
        elsif product.handle != closest.product.handle and settings.currency_code_enabled_product_cards
          assign unit_price = selected_variant.unit_price | money_with_currency
        else
          assign unit_price = selected_variant.unit_price | money
        endif
      -%}
      {% render 'unit-price', price: unit_price, measurement: selected_variant.unit_price_measurement %}
    {%- endif -%}
  </div>

  {%- comment -%} 已售数量（仅在非产品详情页显示） {%- endcomment -%}
  {%- if product_resource != blank and template.name != 'product' -%}
    {%- liquid
      # 获取今天是一年中的第几天（1-365）
      assign today_day_of_year = 'now' | date: '%j' | plus: 0

      # 使用产品ID生成唯一的基础销量（50-300之间）
      assign product_id_str = product_resource.id | append: ''
      assign last_digit = product_id_str | slice: -1, 1 | plus: 0
      assign second_last = product_id_str | slice: -2, 1 | plus: 0
      assign third_last = product_id_str | slice: -3, 1 | plus: 0

      # 基础销量：分步计算避免运算符优先级问题
      assign part1 = last_digit | times: 15
      assign part2 = second_last | times: 10
      assign part3 = third_last | times: 5
      assign base_sold = part1 | plus: part2 | plus: part3 | plus: 50

      # 每天递增量：0-2个（根据产品ID确定固定值，更保守的增长）
      assign daily_increment = last_digit | modulo: 3

      # 计算今年累积的销量（使用今年的天数，不会无限增长）
      assign yearly_increment = today_day_of_year | times: daily_increment

      # 总销量 = 基础销量 + 今年累积
      assign total_sold = base_sold | plus: yearly_increment

      # 限制在999以内
      if total_sold > 999
        assign total_sold = 999
      endif
    -%}
    <span class="sold-count" style="font-size: 0.85em; color: #666; white-space: nowrap;">已售{{ total_sold }}</span>
  {%- endif -%}
</div>
